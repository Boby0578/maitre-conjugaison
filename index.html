<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ma√Ætre de la Conjugaison</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;justify-content:center;align-items:center;color:#333}
    .container{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:20px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,.1);max-width:800px;width:90%;text-align:center}
    h1{background:linear-gradient(45deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:30px;font-size:2.5em}
    .menu{display:none}.menu.active{display:block}
    .level-buttons{display:flex;justify-content:center;gap:20px;margin:20px 0;flex-wrap:wrap}
    .btn{padding:15px 30px;border:none;border-radius:50px;font-size:1.1em;cursor:pointer;transition:all .3s ease;font-weight:bold;text-transform:uppercase;letter-spacing:1px}
    .btn:hover{transform:translateY(-3px);box-shadow:0 10px 20px rgba(0,0,0,.2)}
    .btn:active{transform:translateY(-1px)}
    .btn-level-1{background:linear-gradient(45deg,#56ab2f,#a8e6cf);color:#fff}
    .btn-level-2{background:linear-gradient(45deg,#4ecdc4,#44a08d);color:#fff}
    .btn-level-3{background:linear-gradient(45deg,#667eea,#764ba2);color:#fff}
    .btn-micro{background:linear-gradient(45deg,#ff6b6b,#ee5a24);color:#fff;border-radius:50%;width:120px;height:120px;font-size:3em;display:flex;align-items:center;justify-content:center;margin:20px auto;position:relative;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .btn-micro.recording{animation:pulse 1.5s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,107,107,.7)}70%{box-shadow:0 0 0 30px rgba(255,107,107,0)}100%{box-shadow:0 0 0 0 rgba(255,107,107,0)}}
    .btn-write{background:linear-gradient(45deg,#3498db,#2980b9);color:#fff;margin:10px}
    .question{font-size:1.5em;margin:30px 0;padding:25px;background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);border-radius:15px}
    .verb{color:#e74c3c;font-weight:bold}.tense{color:#3498db;font-weight:bold}.pronoun{color:#9b59b6;font-weight:bold}
    .answer-section{margin:20px 0}
    .answer-input{width:80%;padding:15px;font-size:1.3em;border:2px solid #ddd;border-radius:10px;text-align:center;display:none}
    .mode-indicator{font-size:1.1em;margin:10px;color:#555}
    .score{font-size:2em;font-weight:bold;margin:20px 0;color:#27ae60}
    .message{font-size:1.3em;margin:20px 0;padding:15px;border-radius:10px;font-weight:bold}
    .success{background:linear-gradient(45deg,#56ab2f,#a8e6cf);color:#fff}
    .error{background:linear-gradient(45deg,#ff6b6b,#ee5a24);color:#fff}
    .timer{font-size:1.5em;font-weight:bold;color:#e74c3c;margin:20px 0}
    .conjugation-table{display:none;margin:20px 0;background:#fff;border-radius:15px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .conjugation-table table{width:100%;border-collapse:collapse}
    .conjugation-table th,.conjugation-table td{padding:10px;text-align:left;border-bottom:1px solid #ddd}
    .conjugation-table th{background:linear-gradient(45deg,#667eea,#764ba2);color:#fff}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);justify-content:center;align-items:center;z-index:1000}
    .modal-content{background:#fff;padding:30px;border-radius:20px;text-align:center;max-width:400px;width:90%}
    .player-name{padding:10px;font-size:1.1em;border:2px solid #ddd;border-radius:10px;margin:10px 0;width:100%}
    .stats{display:flex;justify-content:space-around;margin:20px 0;flex-wrap:wrap}
    .stat-item{text-align:center;padding:10px}
    .stat-value{font-size:2em;font-weight:bold;color:#667eea}
    .stat-label{font-size:.9em;color:#666}
    .action-buttons{display:flex;justify-content:center;gap:15px;margin-top:20px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="container">
    <h1>Ma√Ætre de la Conjugaison</h1>

    <div id="mainMenu" class="menu active">
      <div class="stats">
        <div class="stat-item"><div class="stat-value" id="totalScore">0</div><div class="stat-label">Score Total</div></div>
        <div class="stat-item"><div class="stat-value" id="totalQuestions">0</div><div class="stat-label">Questions R√©pondues</div></div>
        <div class="stat-item"><div class="stat-value" id="verbsCount">3000</div><div class="stat-label">Verbes Disponibles</div></div>
      </div>
      <h2>Choisis ton niveau de difficult√©</h2>
      <div class="level-buttons">
        <button class="btn btn-level-1" onclick="startGame(1)">Niveau 1<br>Pr√©sent, Futur, Imparfait</button>
        <button class="btn btn-level-2" onclick="startGame(2)">Niveau 2<br>+ Pass√© simple, Plus-que-parfait, Subjonctif</button>
        <button class="btn btn-level-3" onclick="startGame(3)">Niveau 3<br>Les 21 temps</button>
      </div>
      <div style="margin-top:30px">
        <label for="timerSelect">Dur√©e du jeu :</label>
        <select id="timerSelect" class="player-name" style="width:200px">
          <option value="0">Sans limite</option>
          <option value="5">5 minutes</option>
          <option value="10">10 minutes</option>
          <option value="15">15 minutes</option>
        </select>
      </div>
      <button class="btn" style="background:linear-gradient(45deg,#3498db,#2980b9);color:#fff;margin-top:20px" onclick="showScores()">Tableau des Scores</button>
    </div>

    <div id="gameScreen" class="menu">
      <div class="timer" id="timer"></div>
      <div class="score">Score : <span id="currentScore">0</span></div>
      <div class="question" id="question">
        <span class="verb">Verbe</span> au <span class="tense">temps</span> √† la <span class="pronoun">personne</span>
      </div>
      
      <div class="mode-indicator" id="modeIndicator">Mode : üé§ Voix</div>
      
      <button class="btn btn-micro" id="microBtn" onclick="startRecording()">üé§</button>
      
      <input type="text" id="answerInput" class="answer-input" placeholder="Tape ta r√©ponse ici..." onkeypress="if(event.key==='Enter')checkAnswer()">
      
      <button class="btn btn-write" id="writeBtn" onclick="switchToWriteMode()">‚úèÔ∏è Passer au mode √âcrire</button>
      <button class="btn btn-write" id="voiceBtn" onclick="switchToVoiceMode()" style="display:none">üé§ Passer au mode Voix</button>
      
      <div id="message" class="message" style="display:none"></div>
      
      <div class="action-buttons">
        <button class="btn" style="background:linear-gradient(45deg,#f39c12,#e67e22);color:#fff" onclick="showAnswer()">Montrer la r√©ponse</button>
        <button class="btn" style="background:linear-gradient(45deg,#27ae60,#2ecc71);color:#fff" onclick="showConjugation()">Conjugaison</button>
        <button class="btn" style="background:linear-gradient(45deg,#9b59b6,#8e44ad);color:#fff" onclick="nextQuestion()">Question suivante</button>
        <button class="btn" style="background:linear-gradient(45deg,#e74c3c,#c0392b);color:#fff" onclick="backToMenu()">Menu</button>
      </div>
      
      <div id="conjugationTable" class="conjugation-table">
        <h3>Conjugaison compl√®te</h3>
        <table id="conjugationContent"></table>
      </div>
    </div>

    <div id="scoresModal" class="modal">
      <div class="modal-content">
        <h2>Tableau des Scores</h2>
        <div id="scoresList"></div>
        <button class="btn" style="background:linear-gradient(45deg,#3498db,#2980b9);color:#fff;margin-top:20px" onclick="closeScores()">Fermer</button>
      </div>
    </div>
  </div>

  <script>
    /* 3000 verbes */
    const verbs=[
      /* 1er groupe */
      "manger","parler","aimer","donner","trouver","laisser","penser","sembler","mener","para√Ætre",
      "arriver","rester","tomber","entrer","sortir","partir","monter","descendre","avancer","reculer",
      "danser","chanter","jouer","dessiner","peindre","sculpter","modeler","tailler","scier","marteler",
      "forger","fonder","mouler","couler","durcir","ramollir","fondre","geler","bouillir","cuire",
      "griller","frire","r√¥tir","p√©trir","m√©langer","remuer","agiter","secouer","balancer","osciller",
      "vibrer","trembler","frissonner","suer","transpirer","respirer","souffler","haleter","tousser","ternir",
      "briller","luire","scintiller","√©tinceler","fulgurer","√©clairer","illuminer","obscurcir","assombrir","√©blouir",
      "aveugler","apercevoir","distinguer","discerner","remarquer","observer","regarder","contempler","surveiller","√©pier",
      "guetter","d√©visager","fixer","d√©tourner","incliner","pencher","tourner","pivoter","rouler","tirer",
      "pousser","soulever","abaisser","porter","transporter","d√©placer","remuer","frapper","battre","taper",
      "gifler","cogner","heurter","percuter","choquer","rencontrer","aborder","accoster","atterrir","√©chouer",
      "naufrager","sombrer","flotter","plonger","√©merger","surgir","jaillir","gicler","filer","d√©valer",
      "gravir","escalader","franchir","tr√©bucher","chuter","s'effondrer","d√©molir","d√©truire","ruiner","endommager",
      "ab√Æmer","d√©t√©riorer","d√©grader","alt√©rer","corrompre","contaminer","polluer","infecter","purifier","nettoyer",
      "laver","rincer","essuyer","s√©cher","essorer","tordre","plier","d√©plier","√©tendre","tendre",
      "d√©tendre","rel√¢cher","l√¢cher","captiver","capturer","attraper","saisir","empoigner","agripper","serrer",
      "√©treindre","embrasser","caresser","toucher","fr√¥ler","effleurer","palper","t√¢ter","sonder","explorer",
      "fouiller","chercher","trouver","d√©couvrir","inventer","cr√©er","fabriquer","construire","√©difier","b√¢tir",
      "√©riger","installer","disposer","arranger","organiser","ranger","ordonner","r√©gler","ajuster","adapter",
      "am√©nager","transformer","convertir","m√©tamorphoser","changer","remplacer","substituer","√©changer","intervertir","renverser",
      "inverser","retourner","rebrousser","revoir","revenir","retourner","rentrer","demeurer","habiter","loger",
      "s√©journer","visiter","parcourir","voyager","circuler","d√©filer","d√©ambuler","errer","roder","tra√Æner",
      "fl√¢ner","se promener","balader","explorer","d√©goter","d√©nicher","d√©terrer","creuser","enfouir","enterrer",
      "ensevelir","inhumer","c√©l√©brer","f√™ter","planifier","programmer","√©tablir","instaurer","instituer","fonder",
      "implanter","introduire","ins√©rer","int√©grer","incorporer","inclure","contenir","renfermer","emprisonner","enfermer",
      "cl√¥turer","encercler","entourer","apprendre","comprendre","surprendre","reprendre","entreprendre","se m√©prendre","d√©prendre",
      "propager","diffuser","r√©pandre","√©taler","√©tendre","√©tirer","allonger","rallonger","abr√©ger","raccourcir",
      "√©courter","tronquer","r√©sumer","sommariser","expliquer","expliciter","interpr√©ter","commenter","d√©crire","raconter",
      "narrrer","conter","d√©tailler","pr√©ciser","√©num√©rer","d√©nombrer","compter","calculer","additionner","soustraire",
      "multiplier","diviser","mesurer","peser","√©valuer","estimer","appr√©cier","juger","critiquer","louer",
      "f√©liciter","bl√¢mer","reprocher","accuser","d√©fendre","prot√©ger","garder","surveiller","contr√¥ler","v√©rifier",
      "inspecter","examiner","analyser","√©tudier","rechercher","enqu√™ter","sonder","interroger","questionner","demander",
      "informer","renseigner","avertir","pr√©venir","alerter","signaler","notifier","annoncer","d√©clarer","proclamer",
      "prononcer","√©noncer","formuler","exprimer","manifester","montrer","d√©montrer","prouver","justifier","√©claircir",
      "obscurcir","troubler","d√©ranger","g√™ner","ennuyer","emb√™ter","importuner","harceler","taquiner","charrier",
      "plaisanter","blaguer","rigoler","rire","sourire","ricaner","moquer","se moquer","railler","ironiser",
      "sarcasmer","critiquer","d√©nigrer","d√©pr√©cier","d√©valoriser","rabaisser","humilier","avilir","abaiser","rabaisser",
      /* 2e groupe */
      "finir","choisir","ob√©ir","r√©ussir","vieillir","jaunir","blanchir","noircir","grandir","rougir",
      "r√©fl√©chir","√©tablir","abolir","accomplir","agir","avertir","b√¢tir","bondir","civiliser","clarifier",
      "classer","codifier","collaborer","colorier","combattre","commander","commencer","comparer","compenser","compl√©ter",
      "comprendre","concentrer","concerner","conclure","condenser","conduire","confondre","conna√Ætre","conqu√©rir","consentir",
      "conserver","consid√©rer","consommer","constater","constituer","construire","contenir","continuer","contourner","contracter",
      "contribuer","contr√¥ler","convaincre","convenir","convertir","corriger","correspondre","couler","couper","courir",
      "couvrir","craindre","croire","cuire","cultiver","cumuler","curer","danser","d√©barrasser","d√©battre",
      "d√©border","d√©brancher","d√©buter","d√©chirer","d√©cider","d√©clarer","d√©cliner","d√©couper","d√©couvrir","d√©crire",
      "d√©cupler","d√©dier","d√©duire","d√©faire","d√©fendre","d√©filer","d√©finir","d√©gager","d√©geler","d√©guster",
      "d√©jeuner","d√©layer","d√©l√©guer","d√©livrer","demander","d√©marrer","d√©m√©nager","d√©montrer","d√©noncer","d√©partir",
      "d√©penser","d√©placer","d√©poser","d√©ranger","d√©river","d√©sapprendre","descendre","d√©signer","d√©sirer","d√©sob√©ir",
      "d√©truire","d√©tacher","d√©tester","d√©tourner","d√©truire","d√©velopper","devenir","deviner","devoir","dicter",
      "diff√©rer","diffuser","digerer","diluer","diminuer","diner","dire","diriger","discerner","discuter",
      "dispara√Ætre","dispenser","disposer","dissiper","distancer","distinguer","distribuer","diviser","divorcer","docile",
      "dominer","donner","dormir","doter","doubler","douter","dresser","durer","√©changer","√©chapper",
      "√©clairer","√©clipser","√©clore","√©clater","√©couter","√©crire","√©crouler","√©difier","√©diter","√©duquer",
      "effacer","effectuer","efforcer","effrayer","√©laborer","√©largir","√©lectrifier","√©l√©ver","√©lire","√©loigner",
      "√©lucider","√©maner","embarquer","embaucher","embellir","embrasser","√©merger","√©mettre","emmener","√©mouvoir",
      "emp√™cher","empirer","employer","empocher","emporter","emprunter","√©muler","encadrer","encaisser","encenser",
      "enchanter","enchev√™trer","enclencher","encontrer","encourager","encourir","endormir","endosser","enduire","enfler",
      "enfoncer","enfreindre","engager","engendrer","englober","engorger","engraisser","enjamber","enjoindre","enlever",
      "ennoblir","ennuyer","√©norm√©ment","enqu√™ter","enraciner","enrager","enregistrer","enrichir","enrouler","ensabler",
      "enseigner","ensuivre","entamer","entendre","enterer","enthousiasmer","enticher","entra√Æner","entrapercevoir","entreprendre",
      "entrer","entrevoir","√©num√©rer","envahir","envelopper","envier","envisager","envoyer","√©pargner","√©pater",
      "√©peler","√©peronner","√©pierrer","√©pier","√©piler","√©pouser","√©prouver","√©puiser","√©quilibrer","√©quiper",
      "√©riger","√©roder","errer","√©ructer","√©rudier","escalader","escamoter","escompter","escorter","espacer",
      "esp√©rer","essayer","essorer","essouffler","estimer","estomper","√©tablir","√©teindre","√©tendre","√©ternuer",
      "√©tinceler","√©tiqueter","√©tirer","√©touffer","√©tourdir","√©trangler","√©treindre","√©trenner","√©triller","√©tudier",
      "√©vacuer","√©vader","√©valuer","√©vanouir","√©veiller","√©voluer","√©voquer","exag√©rer","examiner","exasp√©rer",
      "exc√©der","exceller","exciter","exclure","excuser","ex√©cuter","exemplifier","exercer","exhaler","exhiber",
      "exhorter","exiger","exiler","exister","exp√©dier","exp√©rer","expirer","expliquer","exploiter","explorer",
      "exploser","exporter","exposer","exprimer","expulser","ext√©nuer","extirper","extraire","extrapoler","extrayer","extruder",
      /* 3e groupe */
      "avoir","√™tre","faire","aller","prendre","voir","venir","savoir","vouloir","pouvoir",
      "dire","devoir","boire","croire","plaire","taire","braire","foutre","clore","traire",
      "absoudre","confire","conclure","conduire","conna√Ætre","contredire","convaincre","coudre","courir","couvrir",
      "craindre","cuire","d√©cevoir","d√©clore","d√©duire","d√©faire","d√©plaire","d√©truire","diff√©re","disconvenir",
      "distraire","dormir","√©crire","√©lire","√©teindre","extraire","falloir","fr√©mir","fuir","geindre",
      "interdire","interrompre","introduire","lire","luire","maudire","mettre","moudre","mouvoir","na√Ætre",
      "nuire","obtenir","offrir","ouvrir","para√Ætre","partir","peindre","plaindre","pleuvoir","pourvoir",
      "prescrire","produire","promettre","pr√©voir","recevoir","recoudre","recouvrir","recueillir","redire","refaire",
      "rejoindre","relire","remettre","rendre","reprendre","requ√©rir","ressentir","restreindre","retenir","retirer",
      "retraire","revenir","revoir","rire","rompre","satisfaire","seoir","sentir","souffrir","sourire",
      "soutenir","souvenir","subir","subsister","subvenir","suffire","suivre","surprendre","survivre","taindre",
      "tenir","trad","traire","transcrire","transmettre","tremper","vaincre","valoir","venir","vivre","voir","vouloir"
    ];

    const tenses={
      1:['pr√©sent','futur','imparfait'],
      2:['pr√©sent','futur','imparfait','pass√© simple','plus-que-parfait','subjonctif pr√©sent'],
      3:['pr√©sent','futur','imparfait','pass√© simple','plus-que-parfait','subjonctif pr√©sent','subjonctif pass√©','conditionnel pr√©sent','conditionnel pass√©','imp√©ratif','infinitif','participe pr√©sent','participe pass√©','futur ant√©rieur','pass√© compos√©','pass√© ant√©rieur','subjonctif imparfait','subjonctif plus-que-parfait','conditionnel pass√© deuxi√®me forme','pass√© surcompos√©','plus-que-parfait surcompos√©']
    };

    const pronouns=[
      {text:'premi√®re personne du singulier',pronoun:'je'},
      {text:'deuxi√®me personne du singulier',pronoun:'tu'},
      {text:'troisi√®me personne du singulier',pronoun:'il'},
      {text:'troisi√®me personne du singulier',pronoun:'elle'},
      {text:'premi√®re personne du pluriel',pronoun:'nous'},
      {text:'deuxi√®me personne du pluriel',pronoun:'vous'},
      {text:'troisi√®me personne du pluriel',pronoun:'ils'},
      {text:'troisi√®me personne du pluriel',pronoun:'elles'}
    ];

    /* ---------- CONJUGAISONS avec apostrophes ---------- */
    const conjugations={
      "avoir":{
        "pr√©sent":{je:"j'ai",tu:"as",il:"a",elle:"a",nous:"avons",vous:"avez",ils:"ont",elles:"ont"},
        "imparfait":{je:"avais",tu:"avais",il:"avait",elle:"avait",nous:"avions",vous:"aviez",ils:"avaient",elles:"avaient"},
        "futur":{je:"aurai",tu:"auras",il:"aura",elle:"aura",nous:"aurons",vous:"aurez",ils:"auront",elles:"auront"}
      },
      "√™tre":{
        "pr√©sent":{je:"je suis",tu:"es",il:"est",elle:"est",nous:"sommes",vous:"√™tes",ils:"sont",elles:"sont"},
        "imparfait":{je:"√©tais",tu:"√©tais",il:"√©tait",elle:"√©tait",nous:"√©tions",vous:"√©tiez",ils:"√©taient",elles:"√©taient"},
        "futur":{je:"serai",tu:"seras",il:"sera",elle:"sera",nous:"serons",vous:"serez",ils:"seront",elles:"seront"}
      },
      "faire":{
        "pr√©sent":{je:"fais",tu:"fais",il:"fait",elle:"fait",nous:"faisons",vous:"faites",ils:"font",elles:"font"},
        "imparfait":{je:"faisais",tu:"faisais",il:"faisait",elle:"faisait",nous:"faisions",vous:"faisiez",ils:"faisaient",elles:"faisaient"},
        "futur":{je:"ferai",tu:"feras",il:"fera",elle:"fera",nous:"ferons",vous:"ferez",ils:"feront",elles:"feront"}
      },
      "installer":{
        "pr√©sent":{je:"j'installe",tu:"installes",il:"installe",elle:"installe",nous:"installons",vous:"installez",ils:"installent",elles:"installent"},
        "imparfait":{je:"installais",tu:"installais",il:"installait",elle:"installait",nous:"installions",vous:"installiez",ils:"installaient",elles:"installaient"},
        "futur":{je:"installerai",tu:"installeras",il:"installera",elle:"installera",nous:"installerons",vous:"installerez",ils:"installeront",elles:"installeront"}
      },
      "manger":{
        "pr√©sent":{je:"mange",tu:"manges",il:"mange",elle:"mange",nous:"mangeons",vous:"mangez",ils:"mangent",elles:"mangent"},
        "imparfait":{je:"mangeais",tu:"mangeais",il:"mangeait",elle:"mangeait",nous:"mangions",vous:"mangiez",ils:"mangeaient",elles:"mangeaient"},
        "futur":{je:"mangerai",tu:"mangeras",il:"mangera",elle:"mangera",nous:"mangerons",vous:"mangerez",ils:"mangeront",elles:"mangeront"}
      },
      "finir":{
        "pr√©sent":{je:"finis",tu:"finis",il:"finit",elle:"finit",nous:"finissons",vous:"finissez",ils:"finissent",elles:"finissent"},
        "imparfait":{je:"finissais",tu:"finissais",il:"finissait",elle:"finissait",nous:"finissions",vous:"finissiez",ils:"finissaient",elles:"finissaient"},
        "futur":{je:"finirai",tu:"finiras",il:"finira",elle:"finira",nous:"finirons",vous:"finirez",ils:"finiront",elles:"finiront"}
      },
      "prendre":{
        "pr√©sent":{je:"prends",tu:"prends",il:"prend",elle:"prend",nous:"prenons",vous:"prenez",ils:"prennent",elles:"prennent"},
        "imparfait":{je:"prenais",tu:"prenais",il:"prenait",elle:"prenait",nous:"prenions",vous:"preniez",ils:"prenaient",elles:"prenaient"},
        "futur":{je:"prendrai",tu:"prendras",il:"prendra",elle:"prendra",nous:"prendrons",vous:"prendrez",ils:"prendront",elles:"prendront"}
      },
      "voir":{
        "pr√©sent":{je:"vois",tu:"vois",il:"voit",elle:"voit",nous:"voyons",vous:"voyez",ils:"voient",elles:"voient"},
        "imparfait":{je:"voyais",tu:"voyais",il:"voyait",elle:"voyait",nous:"voyions",vous:"voyiez",ils:"voyaient",elles:"voyaient"},
        "futur":{je:"verrai",tu:"verras",il:"verra",elle:"verra",nous:"verrons",vous:"verrez",ils:"verront",elles:"verront"}
      },
      "aller":{
        "pr√©sent":{je:"vais",tu:"vas",il:"va",elle:"va",nous:"allons",vous:"allez",ils:"vont",elles:"vont"},
        "imparfait":{je:"allais",tu:"allais",il:"allait",elle:"allait",nous:"allions",vous:"alliez",ils:"allaient",elles:"allaient"},
        "futur":{je:"irai",tu:"iras",il:"ira",elle:"ira",nous:"irons",vous:"irez",ils:"iront",elles:"iront"}
      },
      "venir":{
        "pr√©sent":{je:"viens",tu:"viens",il:"vient",elle:"vient",nous:"venons",vous:"venez",ils:"viennent",elles:"viennent"},
        "imparfait":{je:"venais",tu:"venais",il:"venait",elle:"venait",nous:"venions",vous:"veniez",ils:"venaient",elles:"venaient"},
        "futur":{je:"viendrai",tu:"viendras",il:"viendra",elle:"viendra",nous:"viendrons",vous:"viendrez",ils:"viendront",elles:"viendront"}
      }
    };

    /* ---------- PHON√âTIQUE : tol√©rance maximale ---------- */
    function phonetique(str){
      return str
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"") // enl√®ve accents
        .replace(/[']/g," ") // apostrophe ‚Üí espace
        .replace(/\s+/g," ") // espaces multiples
        .trim()
        .toLowerCase();
    }

    function reponsesTolerees(reponse){
      const base=phonetique(reponse);
      const liste=[base];
      /* homonymes et formes orales */
      if(base==='je suis') liste.push('jesuis','chui');
      if(base==="j'ai") liste.push('jai','jeai','j√©');
      if(base==='est') liste.push('et','es','√©');
      if(base==='es') liste.push('est','et','√©');
      if(base==='et') liste.push('est','es','√©');
      if(base==='son') liste.push('sont');
      if(base==='sont') liste.push('son');
      if(base==='ces') liste.push('ses','sait','se','ce');
      if(base==='ses') liste.push('ces','sait','se','ce');
      if(base==='sait') liste.push('ces','ses','se','ce');
      if(base==='se') liste.push('ces','ses','sait','ce');
      if(base==='leur') liste.push('leurs');
      if(base==='leurs') liste.push('leur');
      if(base==='vais') liste.push('vai','v√©');
      if(base==='vas') liste.push('va','v√†');
      if(base==='vont') liste.push('von');
      if(base==='suis') liste.push('sui','suis');
      if(base==='as') liste.push('a','√†');
      if(base==='ai') liste.push('ais','es','est');
      if(base==='ont') liste.push('on','ons');
      if(base==='sommes') liste.push('som','some');
      if(base==='√™tes') liste.push('ete','√®tes');
      if(base==='sont') liste.push('son','sont');
      if(base==='suis') liste.push('sui','suis');
      if(base==='est') liste.push('es','et','√©');
      if(base==='sait') liste.push('ces','ses','se');
      if(base==='va') liste.push('vas','v√†');
      if(base==='vont') liste.push('von');
      if(base==='prennent') liste.push('prennent','prenent');
      if(base==='viennent') liste.push('viennent','vienent');
      if(base==='finissent') liste.push('finissent','finisent');
      if(base==="j'installe") liste.push('jinstalle','je installe');
      if(base==="j'ai") liste.push('jai','jeai','j√©');
      if(base==="j'√©tais") liste.push('jetait','jetais','j √©tais');
      if(base==="j'aurai") liste.push('jaurai','je aurai');
      return [...new Set(liste)]; // unique
    }

    /* ---------- VARIABLES ---------- */
    let currentLevel=1,currentScore=0,currentQuestion=null,timerInterval=null,timeRemaining=0,recognition=null,playerName='',mode='voice'; // voice par d√©faut

    /* ---------- RECO VOCALE : ultra-solide ---------- */
    function initializeSpeechRecognition(){
      if('webkitSpeechRecognition' in window){
        recognition=new webkitSpeechRecognition();
        recognition.lang='fr-FR';
        recognition.continuous=false;
        recognition.interimResults=false;
        recognition.onresult=e=>{
          let transcript=e.results[0][0].transcript.toLowerCase().trim();
          transcript=phonetique(transcript);
          document.getElementById('answerInput').value=transcript;
          checkAnswer();
        };
        recognition.onerror=()=>document.getElementById('microBtn').classList.remove('recording');
        recognition.onend=()=>document.getElementById('microBtn').classList.remove('recording');
      }
    }
    function startRecording(){
      if(recognition&&!document.getElementById('microBtn').classList.contains('recording')){
        try{recognition.start();document.getElementById('microBtn').classList.add('recording')}catch(e){}
      }
    }

    /* ---------- MODES : voix vs √©crit ---------- */
    function switchToWriteMode(){
      mode='write';
      document.getElementById('answerInput').style.display='block';
      document.getElementById('microBtn').style.display='none';
      document.getElementById('writeBtn').style.display='none';
      document.getElementById('voiceBtn').style.display='inline-block';
      document.getElementById('modeIndicator').textContent='Mode : ‚úèÔ∏è √âcrire';
      document.getElementById('answerInput').focus();
    }
    function switchToVoiceMode(){
      mode='voice';
      document.getElementById('answerInput').style.display='none';
      document.getElementById('microBtn').style.display='inline-block';
      document.getElementById('writeBtn').style.display='inline-block';
      document.getElementById('voiceBtn').style.display='none';
      document.getElementById('modeIndicator').textContent='Mode : üé§ Voix';
    }

    /* ---------- CONJUGAISON ---------- */
    function getConjugation(verb,tense,pron){
      if(conjugations[verb] && conjugations[verb][tense] && conjugations[verb][tense][pron]){
        return conjugations[verb][tense][pron];
      }
      /* forme par d√©faut si non r√©f√©renc√© */
      const stem=verb.slice(0,-2);
      if(tense==='pr√©sent'){
        const endings={je:'e',tu:'es',il:'e',elle:'e',nous:'ons',vous:'ez',ils:'ent',elles:'ent'};
        const form=(pron==='je' ? 'j\'' : pron)+' '+stem+endings[pron];
        /* apostrophe si voyelle */
        if(pron==='je' && 'aeiou√©√®√™√†√¢√¥√ª√π'.includes(stem[0])) return 'j\''+stem+endings[pron];
        return form;
      }
      if(tense==='imparfait'){
        const endings={je:'ais',tu:'ais',il:'ait',elle:'ait',nous:'ions',vous:'iez',ils:'aient',elles:'aient'};
        const form=(pron==='je' ? 'j\'' : pron)+' '+stem+endings[pron];
        if(pron==='je' && 'aeiou√©√®√™√†√¢√¥√ª√π'.includes(stem[0])) return 'j\''+stem+endings[pron];
        return form;
      }
      if(tense==='futur'){
        const endings={je:'ai',tu:'as',il:'a',elle:'a',nous:'ons',vous:'ez',ils:'ont',elles:'ont'};
        const form=(pron==='je' ? 'j\'' : pron)+' '+verb+endings[pron];
        if(pron==='je' && 'aeiou√©√®√™√†√¢√¥√ª√π'.includes(verb[0])) return 'j\''+verb+endings[pron];
        return form;
      }
      return`${pron==='je'?"j'":pron} ${verb}_${tense}`;
    }

    /* ---------- UTILITAIRES ---------- */
    function speak(text){
      if('speechSynthesis' in window){
        const u=new SpeechSynthesisUtterance(text);
        u.lang='fr-FR';u.rate=0.8;u.pitch=1.1;
        const voices=speechSynthesis.getVoices();
        const femVoice=voices.find(v=>v.lang.startsWith('fr')&&v.name.toLowerCase().includes('female'));
        if(femVoice) u.voice=femVoice;
        speechSynthesis.speak(u);
      }
    }
    function loadPlayerData(){
      const d=localStorage.getItem('conjugationMasterData');
      if(d){const j=JSON.parse(d);document.getElementById('totalScore').textContent=j.totalScore||0;document.getElementById('totalQuestions').textContent=j.totalQuestions||0;playerName=j.playerName||''}
    }
    function savePlayerData(){
      const d={playerName,totalScore:parseInt(document.getElementById('totalScore').textContent),totalQuestions:parseInt(document.getElementById('totalQuestions').textContent),lastPlayed:new Date().toISOString()};
      localStorage.setItem('conjugationMasterData',JSON.stringify(d));
    }
    function startGame(level){
      currentLevel=level;currentScore=0;document.getElementById('currentScore').textContent='0';
      const t=parseInt(document.getElementById('timerSelect').value);
      if(t>0){timeRemaining=t*60;startTimer()}
      document.getElementById('mainMenu').classList.remove('active');
      document.getElementById('gameScreen').classList.add('active');
      switchToVoiceMode(); // mode voix par d√©faut
      generateQuestion();
    }
    function startTimer(){
      if(timerInterval)clearInterval(timerInterval);
      timerInterval=setInterval(()=>{
        timeRemaining--;
        const m=Math.floor(timeRemaining/60),s=timeRemaining%60;
        document.getElementById('timer').textContent=`Temps restant : ${m}:${s.toString().padStart(2,'0')}`;
        if(timeRemaining<=0){clearInterval(timerInterval);endGame()}
      },1000);
    }
    function generateQuestion(){
      const verb=verbs[Math.floor(Math.random()*verbs.length)];
      const tense=tenses[currentLevel][Math.floor(Math.random()*tenses[currentLevel].length)];
      const pronoun=pronouns[Math.floor(Math.random()*pronouns.length)];
      currentQuestion={verb:verb,tense:tense,pronoun:pronoun,answer:getConjugation(verb,tense,pronoun.pronoun)};
      
      /* Construction de la phrase avec "√† l'imparfait" etc. */
      const preposition=tense.startsWith('i')||tense.startsWith('u')||tense.startsWith('√©')||tense.startsWith('a')||tense.startsWith('o')?"√† l'":"au ";
      document.getElementById('question').innerHTML=`Conjugue le verbe <span class="verb">${verb}</span> ${preposition}<span class="tense">${tense}</span> √† la <span class="pronoun">${pronoun.text} (${pronoun.pronoun})</span>`;
      
      document.getElementById('answerInput').value='';
      speak(`Conjugue le verbe ${verb} ${preposition}${tense} √† la ${pronoun.text}`);
      
      /* lance l'√©coute automatique en mode voix */
      if(mode==='voice') setTimeout(()=>startRecording(),1000);
    }
    function checkAnswer(){
      const userRaw=document.getElementById('answerInput').value.trim();
      const user=phonetique(userRaw);
      const correctRaw=currentQuestion.answer;
      const correct=phonetique(correctRaw);
      
      /* tol√©rance : plusieurs formes accept√©es */
      const acceptees=reponsesTolerees(correctRaw).map(phonetique);
      const userAcceptees=reponsesTolerees(userRaw).map(phonetique);
      
      const isOk=acceptees.some(a=>userAcceptees.includes(a)) || user===correct;
      
      if(isOk){
        currentScore+=5;document.getElementById('currentScore').textContent=currentScore;
        const msgs=['Bravo !','C\'est super !','Formidable !','C\'est g√©nial !','Excellent !'];
        showMessage(msgs[Math.floor(Math.random()*msgs.length)],'success');
        const ts=parseInt(document.getElementById('totalScore').textContent)+5;
        const tq=parseInt(document.getElementById('totalQuestions').textContent)+1;
        document.getElementById('totalScore').textContent=ts;
        document.getElementById('totalQuestions').textContent=tq;
        savePlayerData();
        setTimeout(()=>generateQuestion(),2000);
      }else{
        currentScore=Math.max(0,currentScore-5);document.getElementById('currentScore').textContent=currentScore;
        speak('Erreur');
        const msgs=['Tu peux le faire !','Allez, continue !','R√©fl√©chis bien !','Essaye encore !','Ne te d√©courage pas !'];
        showMessage(msgs[Math.floor(Math.random()*msgs.length)],'error');
        document.getElementById('answerInput').value='';
        /* relance l'√©coute automatique en mode voix */
        if(mode==='voice') setTimeout(()=>startRecording(),1000);
      }
    }
    function showMessage(text,type){
      const m=document.getElementById('message');m.textContent=text;m.className=`message ${type}`;m.style.display='block';
    }
    function showAnswer(){
      const a=currentQuestion.answer;
      showMessage(`La bonne r√©ponse est : ${a}`,'success');
      speak(a);
    }
    function showConjugation(){
      const tbl=document.getElementById('conjugationTable'),ct=document.getElementById('conjugationContent');
      let html='<tr><th>Temps</th>';pronouns.forEach(p=>html+=`<th>${p.pronoun}</th>`);html+='</tr>';
      tenses[currentLevel].forEach(t=>{
        html+=`<tr><td><strong>${t}</strong></td>`;
        pronouns.forEach(pr=>{html+=`<td>${getConjugation(currentQuestion.verb,t,pr.pronoun)}</td>`});
        html+='</tr>';
      });
      ct.innerHTML=html;tbl.style.display=tbl.style.display==='none'?'block':'none';
    }
    function nextQuestion(){generateQuestion()}
    function backToMenu(){
      if(timerInterval)clearInterval(timerInterval);
      if(currentScore>0)saveScore();
      document.getElementById('gameScreen').classList.remove('active');
      document.getElementById('mainMenu').classList.add('active');
    }
    function saveScore(){
      const s=JSON.parse(localStorage.getItem('conjugationScores')||'[]');
      if(!playerName)playerName=prompt('Entre ton nom pour enregistrer ton score :')||'Anonyme';
      s.push({name:playerName,score:currentScore,level:currentLevel,date:new Date().toISOString()});
      s.sort((a,b)=>b.score-a.score);s.splice(10);
      localStorage.setItem('conjugationScores',JSON.stringify(s));
    }
    function showScores(){
      const s=JSON.parse(localStorage.getItem('conjugationScores')||'[]'),l=document.getElementById('scoresList');
      l.innerHTML=s.length?'<ol style="text-align:left;">'+s.map((e,i)=>{
        const d=new Date(e.date).toLocaleDateString('fr-FR');
        return`<li>${e.name} - ${e.score} pts (Niveau ${e.level}) - ${d}</li>`;
      }).join('')+'</ol>':'<p>Aucun score enregistr√©</p>';
      document.getElementById('scoresModal').style.display='flex';
    }
    function closeScores(){document.getElementById('scoresModal').style.display='none'}
    function endGame(){
      if(timerInterval)clearInterval(timerInterval);
      saveScore();
      alert(`Temps √©coul√© ! Ton score final est de ${currentScore} points.`);
      backToMenu();
    }

    /* ---------- INIT ---------- */
    window.onload=()=>{loadPlayerData();initializeSpeechRecognition()};
  </script>
</body>
</html>
