<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ma√Ætre de la Conjugaison</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            max-width: 800px;
            width: 90%;
        }

        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .menu {
            display: none;
            text-align: center;
        }

        .menu.active {
            display: block;
        }

        .level-selection {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 4px 15px 0 rgba(31, 38, 135, 0.2);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px 0 rgba(31, 38, 135, 0.4);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-level {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-level:hover {
            background: linear-gradient(45deg, #00f2fe 0%, #4facfe 100%);
        }

        .btn-start {
            background: linear-gradient(45deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            font-size: 1.3em;
            padding: 20px 40px;
        }

        .btn-start:hover {
            background: linear-gradient(45deg, #38f9d7 0%, #43e97b 100%);
        }

        .game-area {
            display: none;
            text-align: center;
        }

        .game-area.active {
            display: block;
        }

        .question {
            font-size: 1.5em;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            line-height: 1.6;
        }

        .verb { color: #f093fb; }
        .tense { color: #4facfe; }
        .pronoun { color: #43e97b; }

        .microphone-container {
            margin: 30px 0;
        }

        .microphone {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(245, 87, 108, 0.4);
        }

        .microphone:hover {
            transform: scale(1.1);
        }

        .microphone.recording {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(245, 87, 108, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(245, 87, 108, 0); }
            100% { box-shadow: 0 0 0 0 rgba(245, 87, 108, 0); }
        }

        .microphone svg {
            width: 40px;
            height: 40px;
            fill: white;
        }

        .answer-input {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            margin: 20px 0;
            text-align: center;
        }

        .voice-recognition-display {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            font-size: 1.1em;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-recognition-display.active {
            background: rgba(79, 172, 254, 0.3);
            border: 2px solid #4facfe;
        }

        .score {
            font-size: 1.3em;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .message {
            font-size: 1.2em;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .success {
            background: linear-gradient(45deg, #43e97b 0%, #38f9d7 100%);
        }

        .error {
            background: linear-gradient(45deg, #fa709a 0%, #fee140 100%);
        }

        .buttons-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 0.9em;
        }

        .btn-reveal {
            background: linear-gradient(45deg, #fa709a 0%, #fee140 100%);
        }

        .btn-conjugation {
            background: linear-gradient(45deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        .conjugation-table {
            display: none;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border-radius: 15px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .conjugation-table.active {
            display: block;
        }

        .conjugation-table h3 {
            color: #4facfe;
            margin-bottom: 15px;
        }

        .conjugation-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .conjugation-table th,
        .conjugation-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .conjugation-table th {
            background: #f093fb;
            color: white;
        }

        .player-name-input {
            padding: 10px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            margin: 10px;
        }

        .timer-selection {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .timer-display {
            font-size: 2em;
            text-align: center;
            margin: 20px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .leaderboard {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .leaderboard h3 {
            margin-bottom: 15px;
            color: #f093fb;
        }

        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .phonetic-hint {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9em;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ma√Ætre de la Conjugaison</h1>
        
        <!-- Menu Principal -->
        <div id="mainMenu" class="menu active">
            <div class="level-selection">
                <button class="btn btn-level" onclick="selectLevel(1)">Niveau 1</button>
                <button class="btn btn-level" onclick="selectLevel(2)">Niveau 2</button>
                <button class="btn btn-level" onclick="selectLevel(3)">Niveau 3</button>
            </div>
            
            <div class="timer-selection">
                <button class="btn btn-small" onclick="selectTimer(0)">Sans limite</button>
                <button class="btn btn-small" onclick="selectTimer(15)">15 min</button>
                <button class="btn btn-small" onclick="selectTimer(10)">10 min</button>
                <button class="btn btn-small" onclick="selectTimer(5)">5 min</button>
            </div>
            
            <div>
                <input type="text" id="playerName" class="player-name-input" placeholder="Entrez votre nom">
            </div>
            
            <button class="btn btn-start" onclick="startGame()">Commencer</button>
            
            <div id="leaderboard" class="leaderboard">
                <h3>Meilleurs Scores</h3>
                <div id="leaderboardEntries"></div>
            </div>
        </div>
        
        <!-- Zone de Jeu -->
        <div id="gameArea" class="game-area">
            <div class="timer-display" id="timerDisplay"></div>
            
            <div class="score">
                Score: <span id="scoreValue">0</span> points
            </div>
            
            <div id="question" class="question"></div>
            
            <div class="voice-recognition-display" id="voiceDisplay">
                Appuyez sur le micro et prononcez votre r√©ponse
            </div>
            
            <div class="microphone-container">
                <button id="microphone" class="microphone" onclick="toggleRecording()">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                    </svg>
                </button>
            </div>
            
            <input type="text" id="answerInput" class="answer-input" placeholder="Votre r√©ponse ou cliquez sur le micro">
            
            <div id="message" class="message" style="display: none;"></div>
            
            <div class="buttons-row">
                <button class="btn btn-small btn-reveal" onclick="showAnswer()">Montrer la r√©ponse</button>
                <button class="btn btn-small btn-conjugation" onclick="toggleConjugation()">Voir la conjugaison</button>
            </div>
            
            <div id="conjugationTable" class="conjugation-table"></div>
        </div>
    </div>

    <script>
        // Base de donn√©es de verbes
        const verbs = [
            "aimer", "parler", "manger", "chanter", "danser", "travailler", "√©tudier", "jouer", "regarder", "√©couter",
            "avoir", "√™tre", "faire", "aller", "venir", "devoir", "pouvoir", "savoir", "vouloir", "voir",
            "prendre", "comprendre", "apprendre", "boire", "croire", "lire", "dire", "√©crire", "rire", "ouvrir"
        ];

        // Temps de conjugaison
        const tenses = {
            1: ["pr√©sent", "futur", "imparfait"],
            2: ["pr√©sent", "futur", "imparfait", "pass√© simple", "plus-que-parfait", "subjonctif"],
            3: ["pr√©sent", "imparfait", "futur", "pass√© simple", "pass√© compos√©", "plus-que-parfait", "subjonctif"]
        };

        // Pronoms
        const pronouns = [
            { text: "je", display: "je" },
            { text: "tu", display: "tu" },
            { text: "il", display: "il" },
            { text: "elle", display: "elle" },
            { text: "nous", display: "nous" },
            { text: "vous", display: "vous" },
            { text: "ils", display: "ils" },
            { text: "elles", display: "elles" }
        ];

        // Table des ambigu√Øt√©s phon√©tiques
        const phoneticAmbiguities = {
            // Formes qui sonnent pareil mais s'√©crivent diff√©remment
            "ai": ["ai", "ai", "est", "et", "aie", "ait", "hais"],
            "as": ["as", "a", "ha"],
            "est": ["est", "et", "ai", "ait", "aie"],
            "sont": ["sont", "son"],
            "vais": ["vais", "vai", "v√©"],
            "fais": ["fais", "fai", "fait"],
            "peux": ["peux", "peut", "peu"],
            "veux": ["veux", "veut", "v≈ìu"],
            "dois": ["dois", "doit", "droit"],
            "vois": ["vois", "voit", "voie"],
            "crois": ["crois", "croit", "croix"],
            "bois": ["bois", "boit", "boie"],
            "prends": ["prends", "prend", "pris"],
            "comprends": ["comprends", "comprend", "compris"],
            "apprends": ["apprends", "apprend", "appris"],
            "lis": ["lis", "lit", "lie"],
            "dis": ["dis", "dit", "die"],
            "√©cris": ["√©cris", "√©crit", "√©crit"],
            "ouvre": ["ouvre", "ouvert", "ouvr√©"],
            "finis": ["finis", "finit", "fini"],
            "choisis": ["choisis", "choisit", "choisi"],
            "grandis": ["grandis", "grandit", "grandi"],
            "rougis": ["rougis", "rougit", "rougi"],
            "jaunis": ["jaunis", "jaunit", "jauni"],
            "noircis": ["noircis", "noircit", "noirci"],
            "blanchis": ["blanchis", "blanchit", "blanchi"]
        };

        // Variables globales
        let currentLevel = 1;
        let currentTimer = 0;
        let currentScore = 0;
        let currentVerb = "";
        let currentTense = "";
        let currentPronoun = "";
        let correctAnswer = "";
        let isRecording = false;
        let recognition = null;
        let timerInterval = null;
        let timeRemaining = 0;

        // S√©lection du niveau
        function selectLevel(level) {
            currentLevel = level;
            document.querySelectorAll('.btn-level').forEach(btn => {
                btn.style.background = 'linear-gradient(45deg, #4facfe 0%, #00f2fe 100%)';
            });
            event.target.style.background = 'linear-gradient(45deg, #f093fb 0%, #f5576c 100%)';
        }

        // S√©lection du timer
        function selectTimer(minutes) {
            currentTimer = minutes;
            document.querySelectorAll('.timer-selection .btn').forEach(btn => {
                btn.style.background = 'linear-gradient(45deg, #4facfe 0%, #00f2fe 100%)';
            });
            event.target.style.background = 'linear-gradient(45deg, #f093fb 0%, #f5576c 100%)';
        }

        // Initialisation de la reconnaissance vocale
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'fr-FR';
                
                recognition.onstart = function() {
                    document.getElementById('voiceDisplay').classList.add('active');
                    document.getElementById('voiceDisplay').textContent = 'üé§ √âcoute en cours...';
                };
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript.toLowerCase().trim();
                    document.getElementById('voiceDisplay').textContent = `J'ai entendu : "${transcript}"`;
                    
                    // Traiter la r√©ponse vocale
                    processVoiceAnswer(transcript);
                };
                
                recognition.onerror = function(event) {
                    console.error('Erreur de reconnaissance:', event.error);
                    document.getElementById('voiceDisplay').textContent = 'Erreur de reconnaissance, veuillez r√©essayer';
                    document.getElementById('voiceDisplay').classList.remove('active');
                    stopRecording();
                };
                
                recognition.onend = function() {
                    document.getElementById('voiceDisplay').classList.remove('active');
                    stopRecording();
                };
            }
        }

        // Traiter la r√©ponse vocale avec gestion des ambigu√Øt√©s
        function processVoiceAnswer(voiceAnswer) {
            // Afficher ce qui a √©t√© entendu
            document.getElementById('answerInput').value = voiceAnswer;
            
            // Nettoyer la r√©ponse
            voiceAnswer = voiceAnswer.toLowerCase().trim();
            
            // Si la r√©ponse exacte est correcte
            if (isAnswerCorrect(voiceAnswer)) {
                checkAnswer(voiceAnswer);
                return;
            }
            
            // V√©rifier les ambigu√Øt√©s phon√©tiques
            let correctedAnswer = handlePhoneticAmbiguities(voiceAnswer);
            
            if (correctedAnswer && correctedAnswer !== voiceAnswer) {
                document.getElementById('voiceDisplay').innerHTML = 
                    `J'ai entendu : "${voiceAnswer}"<br>
                     <span style="color: #43e97b;">Correction automatique : ${correctedAnswer}</span>`;
                document.getElementById('answerInput').value = correctedAnswer;
                
                // V√©rifier si la r√©ponse corrig√©e est correcte
                if (isAnswerCorrect(correctedAnswer)) {
                    checkAnswer(correctedAnswer);
                    return;
                }
            }
            
            // Si aucune correction n'a fonctionn√©
            checkAnswer(voiceAnswer);
        }

        // G√©rer les ambigu√Øt√©s phon√©tiques
        function handlePhoneticAmbiguities(answer) {
            // Diviser la r√©ponse en mots
            const words = answer.split(' ');
            let corrected = [];
            let hasCorrection = false;
            
            words.forEach(word => {
                // V√©rifier si le mot a des ambigu√Øt√©s phon√©tiques
                let correctedWord = word;
                
                // Pour chaque forme correcte possible
                for (let [spokenForm, possibleWritings] of Object.entries(phoneticAmbiguities)) {
                    if (word === spokenForm) {
                        // Trouver la forme correcte pour ce verbe et ce temps
                        let correctForm = findCorrectPhoneticForm(word);
                        if (correctForm && correctForm !== word) {
                            correctedWord = correctForm;
                            hasCorrection = true;
                            break;
                        }
                    }
                }
                
                corrected.push(correctedWord);
            });
            
            return hasCorrection ? corrected.join(' ') : null;
        }

        // Trouver la forme phon√©tique correcte
        function findCorrectPhoneticForm(spokenWord) {
            const correctAnswer = conjugateVerb(currentVerb, currentTense, currentPronoun.text).toLowerCase();
            const pronoun = currentPronoun.text.toLowerCase();
            
            // Si la r√©ponse compl√®te est dans les ambigu√Øt√©s
            if (phoneticAmbiguities[spokenWord]) {
                // V√©rifier si la bonne r√©ponse est dans les possibilit√©s
                for (let form of phoneticAmbiguities[spokenWord]) {
                    if (form === correctAnswer || 
                        (pronoun + ' ' + form) === (pronoun + ' ' + correctAnswer)) {
                        return form;
                    }
                }
            }
            
            return null;
        }

        // V√©rifier si une r√©ponse est correcte (avec tol√©rance)
        function isAnswerCorrect(userAnswer) {
            const alternatives = getAnswerAlternatives(correctAnswer);
            return alternatives.some(alt => userAnswer === alt.toLowerCase());
        }

        // Obtenir toutes les formes alternatives acceptables
        function getAnswerAlternatives(correctAnswer) {
            let alternatives = [correctAnswer.toLowerCase()];
            
            // G√©rer l'√©lision
            if (correctAnswer.startsWith("j'")) {
                alternatives.push(correctAnswer.replace("j'", "je ").toLowerCase());
            }
            
            // G√©rer les formes avec/sans pronom
            const pronoun = currentPronoun.text.toLowerCase();
            if (!correctAnswer.toLowerCase().startsWith(pronoun)) {
                alternatives.push((pronoun + ' ' + correctAnswer).toLowerCase());
            }
            
            return alternatives;
        }

        // Toggle enregistrement
        function toggleRecording() {
            if (!recognition) {
                alert('La reconnaissance vocale n\'est pas support√©e par votre navigateur');
                return;
            }
            
            if (isRecording) {
                recognition.stop();
            } else {
                recognition.start();
                isRecording = true;
                document.getElementById('microphone').classList.add('recording');
            }
        }

        // Arr√™ter l'enregistrement
        function stopRecording() {
            isRecording = false;
            document.getElementById('microphone').classList.remove('recording');
        }

        // Commencer le jeu
        function startGame() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('Veuillez entrer votre nom');
                return;
            }
            
            localStorage.setItem('playerName', playerName);
            document.getElementById('mainMenu').classList.remove('active');
            document.getElementById('gameArea').classList.add('active');
            
            if (currentTimer > 0) {
                timeRemaining = currentTimer * 60;
                startTimer();
            }
            
            generateQuestion();
        }

        // Timer
        function startTimer() {
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    endGame();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // G√©n√©rer une question
        function generateQuestion() {
            currentVerb = verbs[Math.floor(Math.random() * verbs.length)];
            currentTense = tenses[currentLevel][Math.floor(Math.random() * tenses[currentLevel].length)];
            currentPronoun = pronouns[Math.floor(Math.random() * pronouns.length)];
            
            correctAnswer = conjugateVerb(currentVerb, currentTense, currentPronoun.text);
            
            const questionText = `Conjugue le verbe <span class="verb">${currentVerb}</span> 
                                 <span class="tense">au ${currentTense}</span> 
                                 <span class="pronoun">√† la ${getPronounDescription(currentPronoun.text)}</span>`;
            
            document.getElementById('question').innerHTML = questionText;
            document.getElementById('answerInput').value = '';
            document.getElementById('voiceDisplay').textContent = 'Appuyez sur le micro et prononcez votre r√©ponse';
            document.getElementById('message').style.display = 'none';
            document.getElementById('conjugationTable').classList.remove('active');
            
            // √ânoncer la question
            speakQuestion();
        }

        // Obtenir la description du pronom
        function getPronounDescription(pronoun) {
            const descriptions = {
                "je": "premi√®re personne du singulier (je)",
                "tu": "deuxi√®me personne du singulier (tu)",
                "il": "troisi√®me personne du singulier (il)",
                "elle": "troisi√®me personne du singulier (elle)",
                "nous": "premi√®re personne du pluriel (nous)",
                "vous": "deuxi√®me personne du pluriel (vous)",
                "ils": "troisi√®me personne du pluriel (ils)",
                "elles": "troisi√®me personne du pluriel (elles)"
            };
            return descriptions[pronoun];
        }

        // Conjugaison des verbes
        function conjugateVerb(verb, tense, pronoun) {
            // Exceptions courantes
            const exceptions = {
                "avoir": {
                    "pr√©sent": { "je": "j'ai", "tu": "as", "il": "a", "nous": "avons", "vous": "avez", "ils": "ont" },
                    "imparfait": { "je": "j'avais", "tu": "avais", "il": "avait", "nous": "avions", "vous": "aviez", "ils": "avaient" },
                    "futur": { "je": "aurai", "tu": "auras", "il": "aura", "nous": "aurons", "vous": "aurez", "ils": "auront" }
                },
                "√™tre": {
                    "pr√©sent": { "je": "suis", "tu": "es", "il": "est", "nous": "sommes", "vous": "√™tes", "ils": "sont" },
                    "imparfait": { "je": "√©tais", "tu": "√©tais", "il": "√©tait", "nous": "√©tions", "vous": "√©tiez", "ils": "√©taient" },
                    "futur": { "je": "serai", "tu": "seras", "il": "sera", "nous": "serons", "vous": "serez", "ils": "seront" }
                },
                "faire": {
                    "pr√©sent": { "je": "fais", "tu": "fais", "il": "fait", "nous": "faisons", "vous": "faites", "ils": "font" },
                    "imparfait": { "je": "faisais", "tu": "faisais", "il": "faisait", "nous": "faisions", "vous": "faisiez", "ils": "faisaient" },
                    "futur": { "je": "ferai", "tu": "feras", "il": "fera", "nous": "ferons", "vous": "ferez", "ils": "feront" }
                },
                "aller": {
                    "pr√©sent": { "je": "vais", "tu": "vas", "il": "va", "nous": "allons", "vous": "allez", "ils": "vont" },
                    "imparfait": { "je": "allais", "tu": "allais", "il": "allait", "nous": "allions", "vous": "alliez", "ils": "allaient" },
                    "futur": { "je": "irai", "tu": "iras", "il": "ira", "nous": "irons", "vous": "irez", "ils": "iront" }
                }
            };
            
            // V√©rifier les exceptions
            if (exceptions[verb] && exceptions[verb][tense]) {
                return exceptions[verb][tense][pronoun] || verb;
            }
            
            // Conjugaison de base pour les verbes r√©guliers
            let stem = verb.slice(0, -2);
            let ending = verb.slice(-2);
            
            if (tense === "pr√©sent") {
                if (ending === "er") {
                    const endings = { "je": "e", "tu": "es", "il": "e", "nous": "ons", "vous": "ez", "ils": "ent" };
                    let conjugated = stem + endings[pronoun];
                    if (pronoun === "je" && /^[aeiou]/.test(conjugated)) {
                        conjugated = "j'" + conjugated;
                    }
                    return conjugated;
                } else if (ending === "ir") {
                    const endings = { "je": "is", "tu": "is", "il": "it", "nous": "issons", "vous": "issez", "ils": "issent" };
                    return stem + endings[pronoun];
                }
            }
            
            return verb;
        }

        // V√©rifier la r√©ponse
        function checkAnswer(userAnswer) {
            // Nettoyer la r√©ponse
            userAnswer = userAnswer.toLowerCase().trim();
            
            // V√©rifier les formes alternatives
            const alternatives = getAnswerAlternatives(correctAnswer);
            
            if (alternatives.some(alt => userAnswer === alt)) {
                // Bonne r√©ponse
                currentScore += 5;
                updateScore();
                showMessage("Bravo ! C'est super !", "success");
                speak("Bravo !");
                
                setTimeout(() => {
                    generateQuestion();
                }, 2000);
            } else {
                // Mauvaise r√©ponse
                currentScore -= 5;
                updateScore();
                showMessage("Erreur ! Tu peux le faire, r√©essaie !", "error");
                speak("Erreur !");
                document.getElementById('answerInput').value = '';
            }
        }

        // Afficher un message
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
        }

        // Mettre √† jour le score
        function updateScore() {
            document.getElementById('scoreValue').textContent = currentScore;
        }

        // Montrer la r√©ponse
        function showAnswer() {
            const answerWithPronoun = `${currentPronoun.display} ${correctAnswer}`;
            showMessage(`La bonne r√©ponse est : ${answerWithPronoun}`, "success");
            speak(answerWithPronoun);
        }

        // Basculer l'affichage de la conjugaison
        function toggleConjugation() {
            const table = document.getElementById('conjugationTable');
            if (table.classList.contains('active')) {
                table.classList.remove('active');
            } else {
                showConjugationTable();
            }
        }

        // Afficher le tableau de conjugaison
        function showConjugationTable() {
            const table = document.getElementById('conjugationTable');
            let html = `<h3>Conjugaison de ${currentVerb}</h3>`;
            
            const mainTenses = ["pr√©sent", "imparfait", "futur"];
            
            html += '<table>';
            html += '<tr><th>Temps</th><th>Je</th><th>Tu</th><th>Il/Elle</th><th>Nous</th><th>Vous</th><th>Ils/Elles</th></tr>';
            
            mainTenses.forEach(tense => {
                html += '<tr>';
                html += `<td>${tense}</td>`;
                pronouns.forEach(pronoun => {
                    const conjugated = conjugateVerb(currentVerb, tense, pronoun.text);
                    html += `<td>${conjugated}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</table>';
            table.innerHTML = html;
            table.classList.add('active');
        }

        // Fonction de synth√®se vocale
        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'fr-FR';
                utterance.rate = 0.9;
                utterance.pitch = 1.1;
                speechSynthesis.speak(utterance);
            }
        }

        // √ânoncer la question
        function speakQuestion() {
            const questionText = `Conjugue le verbe ${currentVerb} au ${currentTense} √† la ${getPronounDescription(currentPronoun.text)}`;
            speak(questionText);
        }

        // Charger le tableau des scores
        function loadLeaderboard() {
            const leaderboard = JSON.parse(localStorage.getItem('leaderboard') || '[]');
            const entries = document.getElementById('leaderboardEntries');
            
            entries.innerHTML = '';
            leaderboard.sort((a, b) => b.score - a.score).slice(0, 5).forEach(entry => {
                const div = document.createElement('div');
                div.className = 'leaderboard-entry';
                div.innerHTML = `<span>${entry.name}</span><span>${entry.score} pts</span>`;
                entries.appendChild(div);
            });
        }

        // Sauvegarder le score
        function saveScore() {
            const playerName = localStorage.getItem('playerName');
            if (!playerName) return;
            
            const leaderboard = JSON.parse(localStorage.getItem('leaderboard') || '[]');
            leaderboard.push({
                name: playerName,
                score: currentScore,
                date: new Date().toISOString()
            });
            
            localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
        }

        // Fin du jeu
        function endGame() {
            saveScore();
            alert(`Jeu termin√© ! Votre score : ${currentScore} points`);
            location.reload();
        }

        // Gestion de la saisie
        document.getElementById('answerInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkAnswer(this.value);
            }
        });

        // Initialisation
        window.onload = function() {
            loadLeaderboard();
            initializeSpeechRecognition();
        };
    </script>
</body>
</html>
